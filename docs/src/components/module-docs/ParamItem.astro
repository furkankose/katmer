---
import ParamList from "./ParamList.astro"
import MarkdocRenderer from "../MarkdocRenderer.astro"
interface Props {
  p: Param
  id: string
  level: number
  isRoot: boolean
}

const { p, id, level, isRoot } = Astro.props
const safe = idSafe(id)
const scopeId = `${safe}-pane`
const label = p.name ?? p.union?.alias ?? ""

// ---------- helpers ----------
function slug(s: string) {
  return (s ?? "")
    .toLowerCase()
    .replaceAll(" ", "-")
    .replaceAll("|", "-")
    .replaceAll("/", "-")
    .replaceAll(":", "-")
    .replaceAll('"', "")
    .replaceAll("'", "")
    .replaceAll("(", "")
    .replaceAll(")", "")
    .replaceAll(",", "")
    .replaceAll("&", "-")
    .replaceAll("=", "-")
    .replaceAll("?", "-")
    .replaceAll("#", "-")
    .replaceAll("+", "-")
    .replaceAll("~", "-")
    .replaceAll("`", "")
    .replaceAll("@", "-")
    .replaceAll(";", "-")
    .replaceAll(">", "-")
    .replaceAll("<", "-")
    .replaceAll("--", "-")
}

function idSafe(s: string) {
  return slug(s)
}

// gather all “object” branches' fields together for the unified “object” tab
const objectBranchesFields = (p: Param): Branch[] => {
  if (!hasUnion(p)) return []
  return p.union!.branches.filter(
    (b) => Array.isArray(b.fields) && b.fields.length > 0
  )
}

function hasUnion(p: Param) {
  return !!(p.union && p.union.branches && p.union.branches.length > 0)
}
function hasObjOnly(p: Param) {
  return !p.union && !!(p.children && p.children.length > 0)
}

function generateTypeLabels(p: Param): string[] {
  if (p.union?.branches?.length) {
    const seen = new Set<string>()
    for (const br of p.union.branches) {
      seen.add(br.label)
    }
    return [...seen]
  }
  return [p.type || "object"]
}

const union = hasUnion(p)
const objOnly = hasObjOnly(p)

const typeLabels = generateTypeLabels(p)

let labels: string[] = []

if (hasUnion(p)) {
  const seen = [] as string[]
  for (const br of p.union!.branches) {
    seen.push(br.label)
  }
  labels = [...seen]
} else if (p.children?.length) {
  labels = ["object"]
}
---

<div
  class={`m-0 px-0 py-3 border-b border-zinc-200/70 dark:border-zinc-700/60`}
>
  <div class="flex items-baseline flex-wrap px-3">
    {
      !isRoot && !!label && (
        <h6
          id={safe}
          class="group scroll-mt-24 font-semibold text-sm leading-6"
        >
          <a
            href={`#${safe}`}
            class="inline-flex align-middle no-underline absolute"
          >
            <i class="ic ic-mask i-ph-link-light -ms-6 pe-2 py-2 top-0 inline-flex opacity-0 group-hover:lg:opacity-100 transition-opacity absolute" />
          </a>
          {label.endsWith("ModuleOptions") ?
            ""
          : <span class="me-3">{label}</span>}
        </h6>
      )
    }
    <span class="text-xs/5 not-content">
      {
        typeLabels.map((lbl, i) => {
          const slugged = slug(lbl + String(i + 1))
          return (
            <>
              <button
                class="inline-flex items-center text-xs/5 rounded  py-0.5 bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 dark:hover:bg-zinc-700 transition"
                data-tab-target={`#${scopeId}-tab-${slugged}`}
                data-tab-scope={`#${scopeId}`}
              >
                {lbl}
              </button>
              {i < typeLabels.length - 1 && (
                <span class="mx-1 opacity-60">|</span>
              )}
            </>
          )
        })
      }
    </span>
    {
      !p.optional && !isRoot && (
        <span class="text-red-500 text-xs/5 ms-auto">required</span>
      )
    }
  </div>
  <div class="mt-3 px-3 text-xs">
    {p.description && <MarkdocRenderer content={p.description} />}
  </div>

  {
    (union || objOnly) && (
      <div id={scopeId} class="not-prose not-content">
        {labels.length && (
          <div class="flex flex-wrap gap-2 px-3 py-2 bg-zinc-50/60 dark:bg-zinc-800/30 not-content">
            <label>Type References:</label>
            {labels.map((lbl, i) => {
              const slugged = slug(lbl + String(i + 1))
              return (
                <button
                  type="button"
                  class="inline-flex items-center text-xs/5 rounded px-2 py-1 bg-white dark:bg-zinc-900 border border-zinc-200/70 dark:border-zinc-700/60 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition"
                  data-tab-target={`#${scopeId}-tab-${slugged}`}
                  data-tab-scope={`#${scopeId}`}
                >
                  {lbl}
                </button>
              )
            })}
          </div>
        )}
        <div class="">
          {union && (
            <>
              {labels.map((lbl, i) => {
                const slugged = slug(lbl + String(i + 1))
                const isObject = lbl === "object"
                return (
                  <div id={`${scopeId}-tab-${slugged}`} hidden>
                    {isObject ?
                      <>
                        {
                          <div class="px-4 text-xs">
                            {p.union?.branches?.at(i)?.description && (
                              <MarkdocRenderer
                                content={p.union?.branches?.at(i)!.description}
                              />
                            )}
                            <div class="mt-2 rounded-sm border border-zinc-200/70 dark:border-zinc-700/60">
                              <ParamList
                                list={p.union?.branches?.at(i)?.fields || []}
                                baseId={`${safe}-branch-${i + 1}`}
                                level={level + 1}
                                isRoot={false}
                              />
                            </div>
                          </div>
                        }
                      </>
                    : <div class="ps-4 py-2">
                        <div class="text-xs/6 opacity-70">
                          No additional fields.
                        </div>
                      </div>
                    }
                  </div>
                )
              })}
            </>
          )}
          {!union && objOnly && (
            <div id={`${scopeId}-tab-object1`} hidden>
              <div class="px-4">
                <div class="mt-2 rounded-sm border border-zinc-200/70 dark:border-zinc-700/60">
                  <ParamList
                    list={p.children!}
                    baseId={`${safe}-obj`}
                    level={level + 1}
                    isRoot={false}
                  />
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    )
  }
</div>
